# Claude Session Manager Configuration
# Copy this file to config.yaml and fill in your values

server:
  host: "127.0.0.1"
  port: 8420

paths:
  log_dir: "/tmp/claude-sessions"
  state_file: "/tmp/claude-sessions/sessions.json"

monitor:
  # Seconds of inactivity before sending idle notification
  idle_timeout: 300
  # How often to check for new output (seconds)
  poll_interval: 1.0
  # Notification settings - control which events to notify about
  notify:
    errors: false              # Notify on error patterns (usually noise)
    permission_prompts: true   # Notify when Claude needs permission
    completion: false          # Notify when task appears complete
    idle: true                 # Notify when session is idle

# Timeout and delay configuration (all values in seconds unless specified)
timeouts:
  # Tmux session creation and interaction timeouts
  tmux:
    # Time to wait for shell exports to complete before starting Claude
    # Must be long enough for bashrc/zshrc to finish setting env vars
    shell_export_settle_seconds: 0.1

    # Time for Claude Code to initialize and show first prompt
    # Based on observed startup time of 2-3 seconds on typical hardware
    claude_init_seconds: 3

    # Shorter wait when no initial prompt is provided
    # Claude starts faster without processing a prompt
    claude_init_no_prompt_seconds: 1

    # Maximum time to wait for tmux send-keys to complete
    # Allows for shell processing and Claude response time
    send_keys_timeout_seconds: 5

    # Small delay after sending keys to ensure they're processed
    # Prevents race conditions with rapid consecutive commands
    send_keys_settle_seconds: 0.3

  # Output monitor timing configuration
  output_monitor:
    # Don't send idle notifications within this time after Claude responds
    # Prevents "idle" notification immediately after completion
    # Set to 5 minutes to avoid noise
    idle_cooldown_seconds: 300

    # Debounce permission prompts - don't notify twice within this window
    # Prevents duplicate notifications for the same permission request
    permission_debounce_seconds: 30

  # Message queue processing timeouts
  message_queue:
    # Timeout for subprocess calls (tmux send-keys, etc)
    # Must be long enough for command to execute but not hang forever
    subprocess_timeout_seconds: 2

    # Longer timeout for async send operations
    # Allows for Claude to process and respond
    async_send_timeout_seconds: 5

    # Initial retry delay for failed deliveries (seconds)
    # Doubles on each retry up to max_retry_delay_seconds
    initial_retry_delay_seconds: 1.0

    # Maximum retry delay (exponential backoff cap)
    max_retry_delay_seconds: 30

    # Poll interval for watch_session idle detection
    # Checks target session status every N seconds
    watch_poll_interval_seconds: 2

  # Server logging and request handling
  server:
    # Log requests that take longer than this (seconds)
    # Helps identify slow endpoints
    slow_request_threshold_seconds: 1.0

    # Log detailed timing for requests faster than slow threshold
    # but slower than this value (seconds)
    request_timing_threshold_seconds: 0.1

    # Log warning if PreToolUse hook takes longer than this
    # Indicates lock contention or slow file operations
    hook_timing_threshold_seconds: 0.05

    # Maximum time to wait for AI summary generation
    # Summary uses Claude API which can be slow
    summary_generation_timeout_seconds: 60

telegram:
  # Bot token from @BotFather (required for Telegram integration)
  token: "YOUR_BOT_TOKEN_HERE"
  # Optional: restrict bot to specific chat IDs (leave empty to allow all)
  allowed_chat_ids: []
  # allowed_chat_ids:
  #   - 123456789
  #   - 987654321

email:
  # Paths to email harness config files
  # Leave empty to use defaults from ../claude-email-automation/
  smtp_config: ""
  imap_config: ""

services:
  # Office automation service (for /password command and other utilities)
  office_automate_url: "http://192.168.5.140:8080"

# Multi-agent coordination settings
claude:
  # Command to spawn Claude Code sessions (user-controlled, agents cannot override)
  command: "claude"
  # Command-line arguments (user-controlled, agents cannot override)
  args:
    - "--bypass-permissions"
  # Default model for spawned sessions (agent can override with --model flag)
  default_model: "sonnet"

# Codex CLI + app-server settings
codex:
  # Command to launch Codex (CLI + app-server)
  command: "codex"
  # Extra args passed to interactive Codex CLI
  args:
    - "--dangerously-bypass-approvals-and-sandbox"
  # Extra args passed to `codex app-server` (override via codex_app_server.* if needed)
  app_server_args: []
  # Default model for Codex turns (optional)
  default_model: null
  # Approval policy: untrusted | on-failure | on-request | never
  approval_policy: "never"
  # Auto-response to approval prompts (accept | acceptForSession | decline | cancel)
  approval_decision: "decline"
  # Sandbox policy for Codex: workspace-write | read-only | danger-full-access
  sandbox: "workspace-write"
  # Request timeout for JSON-RPC calls
  request_timeout_seconds: 60
  # Review-specific timing (for sm review command)
  review:
    default_wait: 600                # Default --wait seconds for reviews
    menu_settle_seconds: 1.0         # Wait for /review menu to appear
    branch_settle_seconds: 1.0       # Wait for branch picker to appear
    steer_delay_seconds: 5.0         # Wait before injecting steer text

child_agents:
  # Auto-completion detection
  auto_complete:
    enabled: true
    idle_timeout: 600  # Seconds (10 minutes)
    detect_completion_phrases: true
    completion_patterns:
      - "complete"
      - "done"
      - "finished"
      - "all tests pass"

  # Cleanup behavior
  cleanup:
    auto_kill_on_complete: false      # Keep tmux session running
    auto_archive_transcript: true     # Save transcript on completion
    archive_path: "/tmp/claude-sessions/archives"

  # Parent notifications (via sending text to parent's Claude input)
  notifications:
    notify_parent_on_complete: true
    notify_parent_on_error: true
    notify_parent_on_idle: true  # When --wait timeout reached

  # Progress tracking (auto-detected from transcript)
  progress:
    enable_token_tracking: true     # Approximate from transcript length
    enable_tool_tracking: true      # Count tool calls in transcript
    snapshot_interval: 30           # Seconds between checks

# sm send v2: Reliable inter-agent messaging
sm_send:
  # Path to SQLite database for message queue persistence
  db_path: "~/.local/share/claude-sessions/message_queue.db"
  # Polling interval when waiting for user input to become stale (seconds)
  input_poll_interval: 5
  # How long unchanged user input must be before we consider it stale (seconds)
  input_stale_timeout: 120
  # Maximum messages to batch in single delivery
  max_batch_size: 10
  # Delay after Escape in urgent mode (milliseconds)
  urgent_delay_ms: 500

# Session defaults
sessions:
  default_working_dir_behavior: "inherit"  # inherit | specify
  inherit_environment_vars:
    - "SSH_AUTH_SOCK"
    - "PATH"
  naming:
    pattern: "{friendly_name}"               # e.g., task1042-fix
    fallback: "child-{short_id}"             # e.g., child-abc123
