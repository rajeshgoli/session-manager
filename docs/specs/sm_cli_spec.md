# Session Manager CLI (`sm`) Specification

A CLI tool for coordinating multiple Claude agents working in the same repository.

---

## Overview

The `sm` CLI provides a simple interface to the session manager API, enabling agents to:
- Discover other agents working in the same workspace
- Understand what other agents are doing
- Coordinate to avoid conflicts
- Fall back gracefully when session manager is unavailable

---

## Environment

Requires `CLAUDE_SESSION_MANAGER_ID` environment variable (set automatically by session manager).

---

## Commands

### `sm name <friendly-name>`

Set a friendly name for this session (propagates to Telegram, other agents).

```bash
$ sm name "scout-epic987"
Name set: scout-epic987 (08bc57cf)
```

Agents should set this on startup based on persona + task:
- `scout-epic987` — Scout investigating epic 987
- `engineer-ticket984` — Engineer implementing ticket 984
- `architect-pr1030` — Architect reviewing PR 1030

**Exit codes:**
- 0: Success
- 1: Failed to set
- 2: Session manager unavailable

---

### `sm me`

Show current session info.

```bash
$ sm me
scout-epic987 (08bc57cf) | waiting_permission | ~/Desktop/fractal-market-simulator
```

**Output format:** `{name} ({id}) | {status} | {working_dir}`

If no friendly name set, shows just the ID.

**Exit codes:**
- 0: Success
- 1: Session manager unavailable or session not found

---

### `sm who`

List other active sessions in the same workspace.

```bash
$ sm who
engineer-ticket984 (a4af4272) | running    | 2min ago
architect-pr1030 (3d9bee4f)   | running    | 5min ago
```

**Output format:** `{name} ({id}) | {status} | {last_activity_relative}`

**Filters:**
- Same `working_dir` as current session
- Excludes current session
- Only shows `running` or `waiting_permission` status (not `idle` or `error`)

**Exit codes:**
- 0: Other agents found
- 1: No other agents (you're alone)
- 2: Session manager unavailable

---

### `sm what <session-id>`

Get AI-generated summary of what a session is doing.

Uses the existing `/sessions/{id}/summary` API which returns a 2-3 sentence summary generated by Claude Haiku from recent terminal output.

```bash
$ sm what a4af4272
Debugging why backtest results differ after the binary search performance fix.
Comparing signal outputs between old and new implementations on ES-5m data.
Currently running comparison script on ES-5m dataset.
```

**Options:**
- `--lines N`: Number of recent output lines to summarize (default: 100)

**Exit codes:**
- 0: Success
- 1: Session not found or summary unavailable
- 2: Session manager unavailable

---

### `sm others`

Combined command: list other agents + what they're doing.

**Worktree handling:** Session manager tracks `working_dir` which is the actual directory path. A worktree at `~/Desktop/fractal-worktree` is a *different* workspace from `~/Desktop/fractal-market-simulator`. This is intentional — if you're in a worktree, you're isolated and don't need to coordinate with the main checkout.

To find agents in *related* workspaces (same repo, different worktrees), use `--repo` flag which matches by git remote URL instead of directory path.

```bash
$ sm others
engineer-ticket984 (a4af4272) | running | 2min ago
  → Debugging backtest differences after perf fix. Comparing signal outputs.

architect-pr1030 (3d9bee4f) | running | 5min ago
  → Investigating signal detection timing issues on ES-30m data.

$ sm others --repo
# Also shows agents in worktrees of the same repo
```

**Output format:**
```
{name} ({id}) | {status} | {last_activity_relative}
  → {summary}
```

**Exit codes:**
- 0: Other agents found
- 1: No other agents (you're alone)
- 2: Session manager unavailable

---

### `sm alone`

Check if you're the only active agent in this workspace. Designed for scripting.

```bash
$ sm alone && echo "Safe to work here"
```

**Output:** None (silent)

**Exit codes:**
- 0: You're alone
- 1: Other agents are active
- 2: Session manager unavailable (conservative: treat as not alone)

---

### `sm task "<description>"`

Register what you're currently working on (stored in session manager).

```bash
$ sm task "reviewing PR 1030"
Task registered for session 08bc57cf
```

This helps other agents understand your context via `sm what`.

**Exit codes:**
- 0: Success
- 1: Failed to register
- 2: Session manager unavailable

---

### `sm lock "<description>"`

Write a local lock file (fallback when session manager unavailable).

```bash
$ sm lock "reviewing PR 1030"
Lock written to .claude/workspace.lock
```

**Lock file format:**
```
session=08bc57cf
task=reviewing PR 1030
branch=dev
started=2026-01-27T10:00:00Z
```

**Exit codes:**
- 0: Lock acquired
- 1: Lock exists (another agent has it)

---

### `sm unlock`

Remove local lock file.

```bash
$ sm unlock
Lock removed
```

**Exit codes:**
- 0: Success (or no lock existed)

---

### `sm status`

Full status: your session + others + lock file state.

```bash
$ sm status
You: 08bc57cf | waiting_permission | ~/Desktop/fractal-market-simulator

Others in this workspace:
  a4af4272 | running | 2min ago
    → Debugging backtest differences after perf fix.

Lock file: none
```

**Exit codes:**
- 0: Success
- 2: Session manager unavailable (will still show lock file status)

---

## Fallback Behavior

When session manager is unavailable (connection refused, timeout):

| Command | Fallback |
|---------|----------|
| `sm me` | Exit 1, print error |
| `sm who` | Check `.claude/workspace.lock`, exit 2 |
| `sm what` | Exit 2, print error |
| `sm others` | Check lock file, show lock owner if present, exit 2 |
| `sm alone` | Check lock file, exit 2 (conservative: not alone) |
| `sm task` | Write to lock file instead |
| `sm lock` | Works (file-based, no API needed) |
| `sm unlock` | Works (file-based, no API needed) |
| `sm status` | Show lock file status only |

---

## Integration with Agent Workflow

### On Session Start

```bash
# Set friendly name based on persona + task
sm name "engineer-ticket984"

# Register what you're doing
sm task "implementing ticket #984 per epic #987"
sm lock "implementing ticket #984"  # fallback
```

**Naming convention:** `{persona}-{task-id}`
- `scout-issue123` — Scout investigating issue 123
- `engineer-ticket984` — Engineer implementing ticket 984
- `architect-pr1030` — Architect reviewing PR 1030
- `em-epic987` — EM orchestrating epic 987

### Before Making Changes

```bash
# Check if others are active
if ! sm alone; then
  # Get context on what they're doing
  sm others

  # Decide: worktree or proceed?
  # If same area of work → use worktree
  # If different area → proceed carefully
fi
```

### On Session End

```bash
sm unlock  # release lock file
```

---

## Implementation Notes

- Timeout: 2 seconds for API calls (fail fast)
- Lock file location: `.claude/workspace.lock` in repo root
- Lock expiry: Consider locks >30 minutes old as stale
- Summary cache: Could cache summaries for 60 seconds to reduce API calls
